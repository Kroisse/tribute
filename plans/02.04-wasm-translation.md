# Wasm Translation (TrunkIR → Wasm)

Goal: compile Tribute end-to-end to WebAssembly (including WasmGC).

## Current State

### Implemented

**Lowering Passes** (`crates/tribute-wasm-backend/src/passes/`):

- `adt_to_wasm` - ADT operations → WasmGC structs
- `arith_to_wasm` - Arithmetic → Wasm numeric ops
- `const_to_wasm` - Constants → Wasm const ops
- `func_to_wasm` - Functions → Wasm functions
- `intrinsic_to_wasm` - WASI intrinsics
- `scf_to_wasm` - Structured control flow

**Wasm Dialect** (`crates/trunk-ir/src/dialect/wasm.rs`):

- Control flow: `block`, `loop`, `if`, `br`, `br_if`, `return`, `call`, `call_indirect`
- Module items: `func`, `import_func`, `export_func`, `memory`, `data`
- Numerics: Full i32/i64/f32/f64 arithmetic, comparison, bitwise
- Locals: `local_get`, `local_set`, `local_tee`
- WasmGC: `struct_new`, `struct_get`, `struct_set`, `ref_null`, `ref_cast`, etc.

**Emitter** (`emit.rs`): Converts wasm dialect → binary via `wasm_encoder`

### Remaining Work

| Issue | Description |
| ----- | ----------- |
| #38 | Add `wasm.table` and `wasm.elem` operations |
| #39 | Add `wasm.global` operations |
| #40 | Add memory load/store operations |
| #41 | Implement closure lowering to Wasm |

## Architecture

```text
TrunkIR Module
    │
    ├─▶ adt_to_wasm
    ├─▶ arith_to_wasm
    ├─▶ const_to_wasm
    ├─▶ func_to_wasm
    ├─▶ intrinsic_to_wasm
    └─▶ scf_to_wasm
    │
    ▼
Wasm Dialect Module
    │
    ▼ emit_wasm()
WebAssembly Binary
```

## References

- `new-plans/lowering.md` - Lowering pass architecture
- `02.03-wasm-runtime-research.md` - Runtime research (Wasmtime recommended)
